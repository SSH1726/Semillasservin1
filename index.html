<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chiles y Cereales Servín</title>
  <style>
    /* ====== ESTILOS ====== */
    :root{
      --vino:#800000;
      --vino-2:#a00000;
      --bg:#f9f1f1;
      --card:#fff;
      --texto:#222;
      --verde:#1a8f2b;
      --gris:#ddd;
      --sombra:0 2px 6px rgba(0,0,0,.1);
    }
    *{box-sizing:border-box}
    body{font-family:Arial,Helvetica,sans-serif;margin:0;background:var(--bg);color:var(--texto)}
    .navbar{background:var(--vino);color:#fff;padding:10px 16px;display:flex;align-items:center;gap:10px}
    .navbar img{height:40px}
    .navbar h1{margin:0;font-size:18px;flex:1;text-align:center;white-space:nowrap}
    .menu-icon{font-size:26px;cursor:pointer}
    .navbar button{background:orange;border:none;border-radius:5px;padding:6px 12px;cursor:pointer}

    .dropdown-menu{display:none;position:absolute;left:10px;right:10px;top:60px;max-width:260px;background:#fff;border-radius:8px;box-shadow:var(--sombra);overflow:hidden;z-index:10}
    .dropdown-menu a{display:block;padding:12px 14px;color:#5a3d23;text-decoration:none;border-bottom:1px solid #eee}
    .dropdown-menu a:hover{background:#fafafa}

    .search-container,.discount-container{display:flex;flex-direction:column;align-items:center;gap:8px;margin:16px auto}
    .search-container input,.discount-container input{
      width:min(400px,90%);padding:10px;border:1px solid var(--vino);border-radius:6px;font-size:16px;
    }

    .categories{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin:10px}
    .categories button{padding:8px 12px;border:none;border-radius:18px;background:#e8e8e8;cursor:pointer}
    .categories button:hover{background:#ddd}

    .products{display:grid;grid-template-columns:repeat(5,1fr);gap:20px;padding:20px}
    @media (max-width:1200px){.products{grid-template-columns:repeat(4,1fr)}}
    @media (max-width:900px){.products{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:680px){.products{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:460px){.products{grid-template-columns:1fr}}

    .product-card{background:var(--card);border-radius:10px;box-shadow:var(--sombra);text-align:center;padding:12px}
    .product-card img{width:120px;height:120px;object-fit:contain;margin-bottom:8px}
    .product-card h3{margin:8px 0 4px;font-size:16px}
    .product-card .price{margin:0;color:var(--verde);font-weight:700;font-size:16px}
    .product-card select,.product-card button{width:90%;padding:10px;margin-top:10px;border:none;border-radius:6px}
    .product-card button{background:var(--vino);color:#fff;cursor:pointer}
    .product-card button:hover{background:var(--vino-2)}

    .whatsapp-btn{
      position:fixed;right:20px;bottom:20px;background:#25D366;color:#fff;padding:12px 20px;border-radius:50px;
      font-weight:700;text-decoration:none;box-shadow:var(--sombra);z-index:9
    }
  </style>
</head>
<body>
  <!-- NAV -->
  <div class="navbar">
    <div class="menu-icon" onclick="toggleMenu()">☰</div>
    <img src="https://a8df956abb.cbaul-cdnwnd.com/f87890b711a8506804ac4dab45807d6c/200000000-0f1d8101b8/700/servin%20logo.jpg?ph=a8df956abb" alt="Servin logo">
    <h1>Chiles y Cereales Servín</h1>
    <button onclick="window.location.href='cart.html'">Ver Carrito</button>
  </div>

  <div class="dropdown-menu" id="dropdownMenu">
    <a href="index.html">Haz tu pedido!</a>
    <a href="about.html">Sobre Nosotros</a>
    <a href="about.html#comentarios">Comentarios</a>
  </div>

  <!-- Buscador -->
  <div class="search-container">
    <input type="text" id="searchInput" placeholder="Buscar producto..." oninput="searchProducts()">
  </div>

  <!-- Descuento -->
  <div class="discount-container">
    <p><strong>¿Tienes un código de descuento?</strong></p>
    <input type="text" id="discountInput" placeholder="Escribe aquí el código (ESPECIAL)" oninput="checkDiscount()">
  </div>

  <!-- Categorías + Productos -->
  <div class="categories"></div>
  <div class="products"><p style="grid-column:1/-1;text-align:center">Cargando productos…</p></div>

  <a href="https://wa.me/524611267217" target="_blank" class="whatsapp-btn">WhatsApp</a>

  <script>
    /* =================== UTILIDADES =================== */
    const SHEET_ID = '1V3idgBFfpsIJdBs3Z6B8FmXOc9e6rGtF45Y_heR96B0';
    // A..O (O=precio especial)
    const QUERY = 'select A,B,C,D,E,F,G,H,I,J,K,L,M,N,O';

    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);

    const isTrue = v => v === true || v === 'TRUE' || v === 'true';
    const isDiscountActive = () => localStorage.getItem('descuentoActivo') === 'true';

    let productosGlobales = [];

    function toggleMenu(){
      const m = $('#dropdownMenu');
      m.style.display = (m.style.display === 'block') ? 'none' : 'block';
    }

    function searchProducts(){
      const term = ($('#searchInput').value || '').toLowerCase();
      $$('.product-card').forEach(card=>{
        const name = card.querySelector('h3').textContent.toLowerCase();
        card.style.display = name.includes(term) ? '' : 'none';
      });
    }

    function checkDiscount(){
      const code = ($('#discountInput').value || '').trim().toUpperCase();
      localStorage.setItem('descuentoActivo', code === 'ESPECIAL' ? 'true' : 'false');
      renderProducts(productosGlobales);
    }

    /* =================== RENDER =================== */
    function renderProducts(products){
      const cont = $('.products');
      cont.innerHTML = '';
      if(!products || !products.length){
        cont.innerHTML = '<p style="grid-column:1/-1;text-align:center">Sin productos.</p>';
        return;
      }

      // ordenar por nombre
      const list = [...products].sort((a,b)=>a.name.localeCompare(b.name));
      const frag = document.createDocumentFragment();
      const descuento = isDiscountActive();

      list.forEach(prod=>{
        // elegir precios (si hay especial y descuento activo, usarlo como precio unitario para cualquier opción)
        const pKg    = descuento && prod.precioEspecial > 0 ? prod.precioEspecial : prod.precioKg;
        const pCost  = descuento && prod.precioEspecial > 0 ? prod.precioEspecial : prod.precioCostalCaja;
        const pPz    = descuento && prod.precioEspecial > 0 ? prod.precioEspecial : prod.precioPz;
        const pCaja  = descuento && prod.precioEspecial > 0 ? prod.precioEspecial : prod.precioCaja;
        const pCub   = descuento && prod.precioEspecial > 0 ? prod.precioEspecial : prod.precioCubeta;

        // opciones
        let options = '';
        let firstPrice = 0;

        if(isTrue(prod.porKg)){
          options += `<option value="250g">250 g ($${(pKg*0.25).toFixed(2)})</option>`;
          options += `<option value="500g">500 g ($${(pKg*0.50).toFixed(2)})</option>`;
          options += `<option value="750g">750 g ($${(pKg*0.75).toFixed(2)})</option>`;
          options += `<option value="kg" selected>1 kg ($${Number(pKg).toFixed(2)})</option>`;
          firstPrice = Number(pKg).toFixed(2);
        }
        if(isTrue(prod.porCostal)){
          const pesoTxt = prod.pesoCostalCaja ? ` (${prod.pesoCostalCaja} kg)` : '';
          options += `<option value="costal">Costal${pesoTxt} ($${Number(pCost).toFixed(2)})</option>`;
          if(!firstPrice) firstPrice = Number(pCost).toFixed(2);
        }
        if(isTrue(prod.porPz)){
          options += `<option value="pieza">Pieza ($${Number(pPz).toFixed(2)})</option>`;
          if(!firstPrice) firstPrice = Number(pPz).toFixed(2);
        }
        if (isTrue(prod.porCaja)){
  const sufijo = prod.pesoCostalCaja ? ` (${prod.pesoCostalCaja} ${unidadCaja(prod)})` : '';
  options += `<option value="caja">Caja${sufijo} ($${Number(pCaja).toFixed(2)})</option>`;
  if(!firstPrice) firstPrice = Number(pCaja).toFixed(2);
}

        if(isTrue(prod.porCubeta)){
          options += `<option value="cubeta">Cubeta ($${Number(pCub).toFixed(2)})</option>`;
          if(!firstPrice) firstPrice = Number(pCub).toFixed(2);
        }

        if(!options){
          // fallback: precio único usando kg
          options = `<option value="kg">Precio único ($${Number(pKg).toFixed(2)})</option>`;
          firstPrice = Number(pKg).toFixed(2);
        }

        const card = document.createElement('div');
        card.className = 'product-card';
        card.dataset.category = prod.category;
        card.innerHTML = `
          <img src="${(prod.image&&prod.image.startsWith('http'))?prod.image:'https://via.placeholder.com/150'}" alt="${prod.name}">
          <h3>${prod.name}</h3>
          <p class="price">$${firstPrice}</p>
          <select onchange='updatePrice(this, ${JSON.stringify(prodToSafe(prod))})'>
            ${options}
          </select>
          <button onclick='addToCart(this, ${JSON.stringify(prodToSafe(prod))})'>Agregar</button>
        `;
        frag.appendChild(card);
      });

      cont.appendChild(frag);
      searchProducts(); // respeta texto ya escrito
    }

    // Reducimos el objeto para embebido en atributos
    function prodToSafe(p){
      return {
        name:p.name, image:p.image, category:p.category,
        precioKg:p.precioKg, precioCostalCaja:p.precioCostalCaja, pesoCostalCaja:p.pesoCostalCaja,
        precioPz:p.precioPz, precioCaja:p.precioCaja, precioCubeta:p.precioCubeta,
        porKg:p.porKg, porCostal:p.porCostal, porPz:p.porPz, porCaja:p.porCaja, porCubeta:p.porCubeta,
        precioEspecial:p.precioEspecial
      };
    }
// Si el producto se vende por pieza y por caja, la caja mostrará "pz"; de lo contrario "kg"
function unidadCaja(prod){
  return isTrue(prod.porPz) ? 'pz' : 'kg';
}

    function currentUnitPrice(prod, value){
      const disc = isDiscountActive() && Number(prod.precioEspecial) > 0;
      const baseKg = disc ? Number(prod.precioEspecial) : Number(prod.precioKg);
      const pCost  = disc ? Number(prod.precioEspecial) : Number(prod.precioCostalCaja);
      const pPz    = disc ? Number(prod.precioEspecial) : Number(prod.precioPz);
      const pCaja  = disc ? Number(prod.precioEspecial) : Number(prod.precioCaja);
      const pCub   = disc ? Number(prod.precioEspecial) : Number(prod.precioCubeta);

      switch(value){
        case '250g': return baseKg*0.25;
        case '500g': return baseKg*0.50;
        case '750g': return baseKg*0.75;
        case 'kg':   return baseKg;
        case 'costal': return pCost;
        case 'pieza':  return pPz;
        case 'caja':   return pCaja;
        case 'cubeta': return pCub;
        default: return baseKg;
      }
    }

    function unitLabel(prod, value){
      if(value==='kg') return '1 kg';
      if(value==='250g'||value==='500g'||value==='750g') return value;
      if(value==='costal') return `Costal${prod.pesoCostalCaja?` (${prod.pesoCostalCaja} kg)`:''}`;
      if(value==='caja') return `Caja${prod.pesoCostalCaja ? ` (${prod.pesoCostalCaja} ${unidadCaja(prod)})` : ''}`;
      if(value==='pieza') return 'Pieza';
      if(value==='cubeta') return 'Cubeta';
      return value;
    }

    function updatePrice(select, prod){
      const n = currentUnitPrice(prod, select.value);
      select.parentElement.querySelector('.price').textContent = '$' + n.toFixed(2);
    }

    /* =================== CARRITO (compatible con cart.html de tus amigos) =================== */
    function addToCart(btn, prod){
      const card = btn.closest('.product-card');
      const option = card.querySelector('select').value;
      const unitPrice = currentUnitPrice(prod, option);
      const name = prod.name;
      const image = (prod.image && prod.image.startsWith('http')) ? prod.image : 'https://via.placeholder.com/150';

      let cart = JSON.parse(localStorage.getItem('cart') || '[]');

      // Consolidar por (name + option)
      const idx = cart.findIndex(it => it.name===name && it.option===option);
      if(idx>-1){
        cart[idx].quantity += 1;
        // mantenemos price como precio unitario (cart.html suele multiplicar)
        cart[idx].price = Number(unitPrice);
      }else{
        cart.push({ name, image, price:Number(unitPrice), option, quantity:1 });
      }
      localStorage.setItem('cart', JSON.stringify(cart));

      // feedback sin alert
      btn.disabled = true;
      const old = btn.textContent;
      btn.textContent = '✓ Agregado';
      setTimeout(()=>{ btn.disabled=false; btn.textContent = old; }, 900);
    }

    /* =================== CARGA DE SHEETS =================== */
    fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tq=${encodeURIComponent(QUERY)}`)
      .then(r=>r.text())
      .then(t=>{
        const data = JSON.parse(t.substr(47).slice(0,-2));
        const rows = data.table?.rows || [];

        const products = rows.map(r=>({
          name: r.c[0]?.v || '',
          category: r.c[1]?.v || '',
          precioKg: Number(r.c[2]?.v || 0),
          image: r.c[3]?.v || '',
          precioCostalCaja: Number(r.c[4]?.v || 0),    // E (usada para costal o caja)
          porKg: isTrue(r.c[5]?.v),
          porCostal: isTrue(r.c[6]?.v),
          pesoCostalCaja: Number(r.c[7]?.v || 0),
          porPz: isTrue(r.c[8]?.v),
          precioPz: Number(r.c[9]?.v || 0),
          porCaja: isTrue(r.c[10]?.v),
          precioCaja: Number(r.c[11]?.v || 0),
          porCubeta: isTrue(r.c[12]?.v),
          precioCubeta: Number(r.c[13]?.v || 0),
          precioEspecial: Number(r.c[14]?.v || 0)      // O (precio especial)
        }));

        productosGlobales = products;
        loadCategories(products);
        // Prefill descuento si ya estaba activo
        if(isDiscountActive()) $('#discountInput').value = 'ESPECIAL';
        renderProducts(products);
      })
      .catch(err=>{
        console.error('Error cargando productos', err);
        $('.products').innerHTML = '<p style="grid-column:1/-1;text-align:center">Error al cargar productos.</p>';
      });

    function loadCategories(products){
      const cont = $('.categories');
      const cats = Array.from(new Set(products.map(p=>p.category).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
      cont.innerHTML = '<button onclick="filterByCategory(\'__all__\')">Ver todos</button>';
      cats.forEach(c=>{
        const b = document.createElement('button');
        b.textContent = c;
        b.onclick = ()=>filterByCategory(c);
        cont.appendChild(b);
      });
    }

    function filterByCategory(category){
      $$('.product-card').forEach(card=>{
        const show = (category==='__all__' || card.dataset.category===category);
        card.style.display = show ? '' : 'none';
      });
      searchProducts(); // respeta filtro de texto
    }
  </script>
</body>
</html>
