<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Chiles y Cereales Servín</title>
<style>
  
  :root{
    --vino:#800000;
    --crema:#f9f1f1;
    --verde:#189a2c;
    --sombra:0 2px 8px rgba(0,0,0,.15);
  }
  *{box-sizing:border-box}
  body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#fff}
  .navbar{
    background:var(--vino);color:#fff;display:flex;align-items:center;
    gap:10px;padding:10px 16px;position:sticky;top:0;z-index:10
  }
  .menu-icon{font-size:26px;cursor:pointer}
  .navbar img{height:42px}
  .navbar h1{margin:0;font-size:18px;flex:1;text-align:center}
  .navbar button{background:orange;border:none;border-radius:6px;padding:6px 10px;cursor:pointer}

  .dropdown-menu{display:none;position:absolute;left:10px;top:60px;background:#fff;border-radius:6px;
    box-shadow:var(--sombra);overflow:hidden}
  .dropdown-menu a{display:block;padding:12px 16px;text-decoration:none;color:#5a3d23;border-bottom:1px solid #eee}
  .dropdown-menu a:hover{background:#fafafa}

  .search-wrap{display:flex;justify-content:center;margin:18px 0}
  .search-wrap input{width:90%;max-width:460px;padding:10px;border:1px solid var(--vino);border-radius:6px}

  /* descuento bloqueado + aplicar */
  .center{display:flex;justify-content:center}
  .lock-btn,.apply-btn,.clear-btn{
    border:none;border-radius:6px;color:#fff;font-weight:600;cursor:pointer;padding:10px 14px
  }
  .lock-btn{background:#000}
  .apply-btn{background:#0b7a34}
  .clear-btn{background:#b73f3f;margin-left:8px}
  .discount-row{display:none;gap:10px;align-items:center;justify-content:center;margin-top:12px}
  .discount-row input{padding:10px;width:60%;max-width:360px;font-size:16px;border:1px solid var(--vino);border-radius:6px}
  .badge-ok{display:none;background:#e9f7ee;color:#0b7a34;border:1px solid #0b7a34;border-radius:6px;
    padding:4px 8px;font-size:12px;margin-left:8px}

  .categories{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin:16px auto 8px}
  .categories button{padding:8px 12px;border:none;border-radius:16px;background:#e3e3e3;cursor:pointer}
  .categories button.active{background:#d2d2d2}

  .products{display:grid;gap:20px;padding:20px;grid-template-columns:repeat(auto-fill,minmax(240px,1fr))}
  .product-card{background:#fff;border-radius:12px;box-shadow:var(--sombra);text-align:center;padding:12px}
  .product-card img{width:120px;height:120px;object-fit:contain;margin-bottom:10px}
  .product-card h3{margin:8px 0 4px;font-size:16px}
  .product-card .price{margin:0;color:#1a7b2a;font-weight:700;font-size:18px}
  .product-card select,.product-card button{width:90%;padding:10px;border:none;border-radius:6px;margin-top:10px}
  .product-card button{background:var(--vino);color:#fff;cursor:pointer}
  .product-card button:hover{opacity:.95}

  .whatsapp-btn{
    position:fixed;right:20px;bottom:20px;background:#25D366;color:#fff;padding:12px 20px;border-radius:50px;
    font-weight:bold;text-decoration:none;box-shadow:var(--sombra);z-index:9
  }
  /* Texto corto del botón (oculto por defecto) */
.cart-btn .btn-short{display:none}

/* Limpieza de header en móvil */
@media (max-width: 600px){
  .navbar{padding:8px 12px; gap:8px}
  .navbar img{display:none;}                  /* ocultar logo SOLO en móvil */
  .menu-icon{font-size:24px}
  .navbar h1{
    font-size:16px;                           /* título más chico */
    line-height:1.15;
    margin:0;
    text-align:left;                          /* evita amontonamiento */
    flex:1;
  }
  .cart-btn{padding:6px 10px; font-size:14px}
  .cart-btn .btn-long{display:none;}          /* esconder “Ver Carrito” */
  .cart-btn .btn-short{display:inline;}       /* mostrar “Carrito” */
}

/* Extra compacto para pantallas muy angostas */
@media (max-width: 380px){
  .navbar h1{font-size:14px}
  .cart-btn{padding:6px 8px; font-size:13px}
}

</style>
</head>
<body>

<div class="navbar">
  <div class="menu-icon" onclick="toggleMenu()">☰</div>

  <!-- el logo se mantiene en el DOM pero lo ocultaremos SOLO en móvil -->
  <img src="https://a8df956abb.cbaul-cdnwnd.com/f87890b711a8506804ac4dab45807d6c/200000000-0f1d8101b8/700/servin%20logo.jpg?ph=a8df956abb" alt="Servin logo">

  <h1>Chiles, Semillas y Cereales Servín</h1>

  <button class="cart-btn" onclick="location.href='cart.html'">
  <span class="btn-long">Ver Carrito</span>
  <span class="btn-short">Carrito</span>
</button>

</div>


<!-- Buscador -->
<div class="search-wrap">
  <input id="searchInput" placeholder="Buscar producto..." oninput="searchProducts()">
</div>

<!-- Descuento bloqueado -->
<div class="center">
  <button class="lock-btn" id="unlockBtn" onclick="showDiscount()">Desbloquear campo</button>
  <span class="badge-ok" id="badgeOk">Código aplicado</span>
</div>
<div class="discount-row" id="discountRow">
  <input id="discountInput" type="password" placeholder="Escribe tu código">
  <button class="apply-btn" onclick="applyDiscount()">Aplicar</button>
  <button class="clear-btn" onclick="clearDiscount()">Limpiar</button>
</div>

<!-- Categorías + Productos -->
<div class="categories" id="catWrap"></div>
<div class="products" id="prodWrap"><p style="text-align:center;width:100%">Cargando…</p></div>

<a class="whatsapp-btn" target="_blank" href="https://wa.me/524611267217">WhatsApp</a>

<script>
  // ====== Estado global
  let productosGlobales = [];
  let descuentoActivo = localStorage.getItem('descuentoActivo') === 'true';

  // ====== Menú
  function toggleMenu(){
    const m=document.getElementById('dropdownMenu');
    m.style.display = m.style.display==='block'?'none':'block';
  }

  // ====== Descuento bloqueado
  function showDiscount(){
    document.getElementById('discountRow').style.display='flex';
    document.getElementById('unlockBtn').style.display='none';
  }
  function applyDiscount(){
    const code = document.getElementById('discountInput').value.trim().toUpperCase();
    if(code==='ESPECIAL'){
      descuentoActivo = true;
      localStorage.setItem('descuentoActivo','true');
      document.getElementById('badgeOk').style.display='inline-block';
      renderProducts(productosGlobales);
    }else{
      alert('Código inválido');
    }
  }
  function clearDiscount(){
    descuentoActivo=false;
    localStorage.setItem('descuentoActivo','false');
    document.getElementById('discountInput').value='';
    document.getElementById('badgeOk').style.display='none';
    renderProducts(productosGlobales);
  }

  // ====== Buscar
  function searchProducts(){
    const q = document.getElementById('searchInput').value.toLowerCase();
    document.querySelectorAll('.product-card').forEach(card=>{
      const name = card.querySelector('h3').textContent.toLowerCase();
      card.style.display = name.includes(q)?'block':'none';
    });
  }

  // ====== Categorías
  function buildCategories(list){
    const wrap = document.getElementById('catWrap');
    const set = new Set(list.map(p=>p.category).filter(Boolean));
    wrap.innerHTML = '';
    const allBtn = document.createElement('button');
    allBtn.textContent = 'Ver todos';
    allBtn.classList.add('active');
    allBtn.onclick = ()=>{
      document.querySelectorAll('.categories button').forEach(b=>b.classList.remove('active'));
      allBtn.classList.add('active');
      filterCategory('');
    };
    wrap.appendChild(allBtn);
    set.forEach(cat=>{
      const b=document.createElement('button');
      b.textContent=cat;
      b.onclick=()=>{
        document.querySelectorAll('.categories button').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        filterCategory(cat);
      };
      wrap.appendChild(b);
    });
  }
  function filterCategory(cat){
    document.querySelectorAll('.product-card').forEach(card=>{
      const c = card.dataset.category || '';
      card.style.display = !cat || c===cat ? 'block' : 'none';
    });
  }

  function renderProducts(list){
  const cont = document.getElementById('prodWrap');
  cont.innerHTML = '';
  const sorted = [...list].sort((a,b)=>a.name.localeCompare(b.name));
  const desc = descuentoActivo === true; // precio especial activo

  sorted.forEach(prod=>{
    // ¿Caja se expresa en piezas?
    const cajaEnPiezas = prod.porCaja && prod.porPz;
    const etiquetaCaja = cajaEnPiezas
      ? `Caja (${prod.pesoCostalCaja||prod.pesoCostal||prod.pesoCaja||0} pz)`
      : `Caja (${prod.pesoCostalCaja||prod.pesoCostal||prod.pesoCaja||0} kg)`;

    // REGLA DE DESCUENTO:
    // - Kg y Pieza pueden usar precio especial
    // - Costal, Caja, Cubeta SIEMPRE precio normal
    const priceKg      = desc && prod.precioEspecial>0 ? prod.precioEspecial : (prod.precioKg||0);
    const pricePieza   = desc && prod.precioEspecial>0 ? prod.precioEspecial : (prod.precioPz||0);
    const priceCostal  = (prod.precioCostalCaja||0); // sin descuento
    const baseCaja     = (prod.precioCaja && prod.precioCaja>0) ? prod.precioCaja : (prod.precioCostalCaja||0); // sin descuento
    const priceCubeta  = (prod.precioCubeta||0); // sin descuento

    let firstPrice = 0;
    let opts = '';

    // KG + fracciones si aplica
    if (prod.porKg){
      opts += `<option value="kg">1 kg ($${Number(priceKg).toFixed(2)})</option>`;
      opts += `<option value="250">250 g ($${Number(priceKg*0.25).toFixed(2)})</option>`;
      opts += `<option value="500">500 g ($${Number(priceKg*0.50).toFixed(2)})</option>`;
      opts += `<option value="750">750 g ($${Number(priceKg*0.75).toFixed(2)})</option>`;
      firstPrice = priceKg;
    }

    // Costal
    if (prod.porCostal){
      const kg = prod.pesoCostalCaja||prod.pesoCostal||0;
      opts += `<option value="costal">Costal (${kg} kg) ($${Number(priceCostal).toFixed(2)})</option>`;
      if (!firstPrice) firstPrice = priceCostal;
    }

    // Pieza
    if (prod.porPz){
      opts += `<option value="pieza">Pieza ($${Number(pricePieza).toFixed(2)})</option>`;
      if (!firstPrice) firstPrice = pricePieza;
    }

    // Caja
    if (prod.porCaja){
      opts += `<option value="caja">${etiquetaCaja} ($${Number(baseCaja).toFixed(2)})</option>`;
      if (!firstPrice) firstPrice = baseCaja;
    }

    // Cubeta
    if (prod.porCubeta){
      opts += `<option value="cubeta">Cubeta ($${Number(priceCubeta).toFixed(2)})</option>`;
      if (!firstPrice) firstPrice = priceCubeta;
    }

    // Fallback por si no hubo ninguna opción
    if (!opts){
      opts = `<option value="unico">Precio único ($${Number(priceKg).toFixed(2)})</option>`;
      firstPrice = priceKg;
    }

    const img = prod.image && prod.image.startsWith('http') ? prod.image : 'https://via.placeholder.com/150';

    const card = document.createElement('div');
    card.className='product-card';
    card.dataset.category = prod.category||'';
    card.innerHTML = `
      <img src="${img}" alt="${prod.name}">
      <h3>${prod.name}</h3>
      <p class="price">$${Number(firstPrice).toFixed(2)}</p>
      <select>${opts}</select>
      <button>Agregar</button>
    `;
    card.querySelector('select').addEventListener('change', e=>updatePrice(e.target, prod));
    card.querySelector('button').addEventListener('click', ()=>addToCart(card, prod));
    cont.appendChild(card);
  });

  // Mantener el filtro de búsqueda activo
  searchProducts();
}


  function updatePrice(select, prod){
    const usarEspecial = descuentoActivo && prod.precioEspecial>0;
    const priceEl = select.closest('.product-card').querySelector('.price');
    const baseCaja = (prod.precioCaja && prod.precioCaja>0)?prod.precioCaja:(prod.precioCostalCaja||0);
    let val = 0;
    switch(select.value){
        case '250g':
  val = (usarEspecial ? prod.precioEspecial : prod.precioKg) * 0.25;
  break;
case '500g':
  val = (usarEspecial ? prod.precioEspecial : prod.precioKg) * 0.50;
  break;
case '750g':
  val = (usarEspecial ? prod.precioEspecial : prod.precioKg) * 0.75;
  break;
      case 'kg':     val = usarEspecial?prod.precioEspecial:prod.precioKg; break;
      case 'costal': val = usarEspecial?prod.precioEspecial:(prod.precioCostalCaja||0); break;
      case 'pieza':  val = usarEspecial?prod.precioEspecial:(prod.precioPz||0); break;
      case 'caja':   val = usarEspecial?prod.precioEspecial:baseCaja; break;
      case 'cubeta': val = usarEspecial?prod.precioEspecial:(prod.precioCubeta||0); break;
      default:       val = usarEspecial?prod.precioEspecial:prod.precioKg;
        
    }
    priceEl.textContent = '$'+Number(val||0).toFixed(2);
  }

  function addToCart(card, prod){
    const name = prod.name;
    const image = (prod.image && prod.image.startsWith('http'))?prod.image:'https://via.placeholder.com/150';
    const option = card.querySelector('select').value;
    const price = Number(card.querySelector('.price').textContent.replace(/[^0-9.]/g,''));
    const item = { name, image, option, price, qty:1 };

    const cart = JSON.parse(localStorage.getItem('cart')||'[]');
    const i = cart.findIndex(x=>x.name===name && x.option===option);
    if(i>-1){ cart[i].qty+=1; cart[i].price+=price; } else { cart.push(item); }
    localStorage.setItem('cart', JSON.stringify(cart));
    // feedback corto
    card.querySelector('button').textContent='✓ Agregado';
    card.querySelector('button').disabled=true;
    setTimeout(()=>{
      card.querySelector('button').textContent='Agregar';
      card.querySelector('button').disabled=false;
    },900);
  }

  // ====== Cargar Google Sheets
  const SHEET_ID='1V3idgBFfpsIJdBs3Z6B8FmXOc9e6rGtF45Y_heR96B0';
  const QUERY='select A,B,C,D,E,F,G,H,I,J,K,L,M,N,O';

  fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tq=${encodeURIComponent(QUERY)}`)
    .then(r=>r.text())
    .then(t=>{
      const data = JSON.parse(t.substr(47).slice(0,-2));
      const rows = data.table.rows||[];
      const prods = rows.map(r=>{
        const c = i=>r.c[i]?.v;
        return {
          name: c(0)||'',
          category: c(1)||'',
          precioKg: Number(c(2)||0),
          image: c(3)||'',
          // E: “Precio costal” (lo usamos también como precio de caja si L está vacío)
          precioCostalCaja: Number(c(4)||0),
          porKg: c(5)==='TRUE'||c(5)===true,
          porCostal: c(6)==='TRUE'||c(6)===true,
          // H: “peso costal” – lo usamos también como cantidad para caja si aplica
          pesoCostalCaja: Number(c(7)||0),
          porPz: c(8)==='TRUE'||c(8)===true,
          precioPz: Number(c(9)||0),
          porCaja: c(10)==='TRUE'||c(10)===true,
          precioCaja: Number(c(11)||0), // si 0, caemos a E
          porCubeta: c(12)==='TRUE'||c(12)===true,
          precioCubeta: Number(c(13)||0),
          precioEspecial: Number(c(14)||0)
        };
      }).filter(p=>p.name); // quita filas vacías

      productosGlobales = prods;
      buildCategories(prods);
      renderProducts(prods);

      // si ya estaba activo el descuento, muestra badge
      if(descuentoActivo) document.getElementById('badgeOk').style.display='inline-block';
    })
    .catch(e=>{
      console.error(e);
      document.getElementById('prodWrap').innerHTML='<p style="text-align:center;width:100%">Error al cargar productos.</p>';
    });
</script>
</body>
</html>
