<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Carrito - Chiles y Cereales Servín</title>
<style>
  :root{
    --vino:#800000; --crema:#f9f1f1; --verde:#189a2c; --gris:#666; --sombra:0 2px 10px rgba(0,0,0,.12);
  }
  *{box-sizing:border-box}
  body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#fff}
  /* NAV */
  .navbar{background:var(--vino);color:#fff;display:flex;align-items:center;gap:10px;padding:10px 16px;position:sticky;top:0;z-index:10}
  .navbar img{height:42px}
  .navbar h1{margin:0;font-size:18px;flex:1;text-align:center}
  .navbar button{background:orange;border:none;border-radius:6px;padding:6px 10px;cursor:pointer;white-space:nowrap}
  /* Contenedor */
  .wrap{max-width:980px;margin:22px auto;padding:0 14px}
  .card{background:#fff;border-radius:12px;box-shadow:var(--sombra);padding:14px}
  .title{margin:0 0 10px 0;font-size:20px}
  /* Lista carrito */
  .cart-empty{padding:26px;text-align:center;color:var(--gris)}
  .row{display:grid;grid-template-columns:64px 1fr auto auto auto;align-items:center;gap:12px;border-bottom:1px solid #eee;padding:10px 0}
  .row:last-child{border-bottom:none}
  .thumb{width:64px;height:64px;object-fit:contain}
  .name{font-weight:700}
  .muted{color:var(--gris);font-size:13px;margin-top:3px}
  .qty{display:flex;align-items:center;gap:6px}
  .qty button{width:28px;height:28px;border:none;background:#eee;border-radius:6px;cursor:pointer}
  .qty input{width:44px;text-align:center;border:1px solid #ddd;border-radius:6px;padding:6px}
  .money{font-weight:700;color:#137a2a;min-width:90px;text-align:right}
  .remove{background:#e24b4b;color:#fff;border:none;border-radius:6px;padding:6px 10px;cursor:pointer}
  .footer{display:flex;justify-content:space-between;align-items:center;margin-top:10px;gap:12px;flex-wrap:wrap}
  .total{font-size:18px;font-weight:700}
  .clear{background:#b73f3f;color:#fff;border:none;border-radius:6px;padding:8px 12px;cursor:pointer}
  /* Datos cliente */
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  .grid input,.grid3 input, .grid textarea{width:100%;padding:10px;border:1px solid #ccc;border-radius:8px}
  .grid textarea{min-height:80px;resize:vertical}
  .cta{background:var(--vino);color:#fff;border:none;border-radius:8px;padding:12px 16px;font-weight:700;cursor:pointer;width:100%}
  .badge{display:inline-block;background:#e9f7ee;color:#0b7a34;border:1px solid #0b7a34;border-radius:6px;padding:4px 8px;font-size:12px;margin-left:8px}
  @media(max-width:680px){
    .row{grid-template-columns:64px 1fr auto;grid-template-areas:
      "img name name"
      "img qty  money"
      "img rem  money";
    }
    .row .thumb{grid-area:img}
  }
</style>
</head>
<body>
  <!-- NAV -->
  <div class="navbar">
    <img src="https://a8df956abb.cbaul-cdnwnd.com/f87890b711a8506804ac4dab45807d6c/200000000-0f1d8101b8/700/servin%20logo.jpg?ph=a8df956abb" alt="Servin">
    <h1>Carrito</h1>
    <button onclick="location.href='index.html'">Volver a la tienda</button>
  </div>

  <div class="wrap">
    <!-- Carrito -->
    <div class="card" id="cartCard">
      <h2 class="title">Tus productos
        <span id="specialBadge" class="badge" style="display:none">Precio especial activo</span>
      </h2>
      <div id="cartList"></div>
      <div class="footer" id="cartFooter" style="display:none">
        <button class="clear" onclick="clearCart()">Vaciar carrito</button>
        <div class="total">Total: $<span id="cartTotal">0.00</span></div>
      </div>
    </div>

    <!-- Datos cliente -->
    <div class="card" style="margin-top:16px">
      <h2 class="title">Datos para tu pedido</h2>
      <div class="grid3" style="margin-bottom:10px">
        <input id="custName" placeholder="Tu nombre" />
        <input id="pickupDate" type="date" />
        <input id="pickupTime" type="time" />
      </div>
      <div class="grid" style="margin-bottom:10px">
        <textarea id="notes" placeholder="Notas (opcional)"></textarea>
      </div>

      <!-- Mensajes -->
      <p id="orderMsg" style="display:none;margin:6px 0 12px;color:#0b7a34"></p>

      <button class="cta" id="sendBtn" onclick="placeOrder()">Guardar y enviar por WhatsApp</button>
    </div>
  </div>

<!-- ============== CONFIG ============== -->
<script>
  // Pega aquí la URL /exec de tu WebApp de Apps Script
  const ORDERS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwz--72VjjDOr7fNPMG7huDeyTWFXbmKIi-tzb5Lzg2DlGoYNxN2EWPGIeEff0RDHWM5A/exec';
  const tel = '524611267217';
</script>

<!-- ============== LÓGICA PRINCIPAL ============== -->
<script>
  // ===== helpers de carrito =====
  const $ = s => document.querySelector(s);
  const getCart = () => JSON.parse(localStorage.getItem('cart')||'[]');
  const setCart = (c) => localStorage.setItem('cart', JSON.stringify(c));

  // ====== API fallback (no bloquea flujo) ======
  async function registerOrder(payload){
    try{
      // Enviamos como text/plain para evitar preflight CORS
      const res = await fetch(ORDERS_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify(payload)
      });
      let data = null;
      try { data = await res.json(); } catch(_) {}
      if (data && data.ok === false) throw new Error(data.error || 'Error servidor');
      return data?.id || null;
    } catch (err) {
      console.warn('Registro en Sheets falló:', err);
      return null;
    }
  }

  // ====== Render ======
  function renderCart(){
    const list = $('#cartList');
    const footer = $('#cartFooter');
    const badge = $('#specialBadge');
    const c = getCart();

    // Mostrar badge si el código ESPECIAL está activo
    const desc = localStorage.getItem('descuentoActivo')==='true';
    badge.style.display = desc ? 'inline-block' : 'none';

    if(!c.length){
      list.innerHTML = '<div class="cart-empty">Tu carrito está vacío.</div>';
      footer.style.display='none';
      $('#cartTotal').textContent='0.00';
      return;
    }

    list.innerHTML = '';
    let total = 0;

    c.forEach((it, i) => {
      const qty  = __getQty(it);
      const unit = __getUnit(it);
      const sub  = unit * qty;
      total += sub;

      // Normaliza estructura
      it.unitPrice = Number(unit.toFixed(2));
      it.price     = Number(sub.toFixed(2)); // compat: price = subtotal
      setCart(c);

      const row = document.createElement('div');
      row.className='row';
      row.innerHTML = `
        <img class="thumb" src="${it.image||'https://via.placeholder.com/64'}" alt="">
        <div>
          <div class="name">${it.name||'Producto'}</div>
          <div class="muted">Opción: ${it.option||'-'} · $${it.unitPrice.toFixed(2)} c/u</div>
        </div>
        <div class="qty">
          <button onclick="chgQty(${i},-1)">−</button>
          <input value="${qty}" readonly>
          <button onclick="chgQty(${i},1)">+</button>
        </div>
        <div class="money">$${sub.toFixed(2)}</div>
        <button class="remove" onclick="removeItem(${i})">Eliminar</button>
      `;
      list.appendChild(row);
    });

    $('#cartTotal').textContent = total.toFixed(2);
    footer.style.display='flex';
  }

  function chgQty(i, delta){
    const c = getCart();
    if(!c[i]) return;
    const qty  = Math.max(0, __getQty(c[i]) + delta);
    const unit = __getUnit(c[i]);

    if(qty===0){ c.splice(i,1); }
    else{
      c[i].qty       = qty;                         // también guardamos como qty
      c[i].quantity  = qty;                         // …y como quantity por compatibilidad
      c[i].unitPrice = Number(unit.toFixed(2));
      c[i].price     = Number((unit*qty).toFixed(2)); // subtotal
    }
    setCart(c);
    renderCart();
  }

  function removeItem(i){
    const c = getCart();
    if(!c[i]) return;
    c.splice(i,1);
    setCart(c);
    renderCart();
  }

  function clearCart(){
    if(!confirm('¿Vaciar todo el carrito?')) return;
    setCart([]);
    renderCart();
  }

  // ===== WhatsApp helper =====
  function buildWhatsappMessage({name, fecha, hora, notas, cart}){
    let msg = `Hola, soy ${encodeURIComponent(name)}.%0AQuiero hacer un pedido:%0A%0A`;
    cart.forEach(it=>{
      const qty  = __getQty(it);
      const unit = __getUnit(it);
      const sub  = unit * qty;
      msg += `• ${encodeURIComponent(it.name)} (${encodeURIComponent(it.option||'-')}) x${qty}: $${sub.toFixed(2)}%0A`;
    });
    const total = cart.reduce((s,it)=> s + (__getUnit(it) * __getQty(it)), 0);
    msg += `%0ATotal: $${total.toFixed(2)}%0A`;
    msg += `%0ARetiro: ${encodeURIComponent(fecha)} a las ${encodeURIComponent(hora)}`;
    if(notas) msg += `%0ANotas: ${encodeURIComponent(notas)}`;
    return msg;
  }

  // ===== Enviar a Sheets + WhatsApp =====
  async function placeOrder(){
    const c = getCart();
    if (!c.length){ alert('Tu carrito está vacío.'); return; }

    const name  = ($('#custName').value||'').trim();
    const fecha = $('#pickupDate').value || '';
    const hora  = $('#pickupTime').value || '';
    const notas = ($('#notes').value||'').trim();
    if(!name){ alert('Escribe tu nombre.'); return; }
    if(!fecha){ alert('Selecciona el día de recogida.'); return; }
    if(!hora){ alert('Selecciona la hora de recogida.'); return; }

    // Items para la API
    const items = c.map(it=>{
      const qty  = __getQty(it);
      const unit = __getUnit(it);
      const line = unit*qty;
      return {
        name: it.name,
        option: it.option||'',
        qty,
        unit: Number(unit.toFixed(2)),
        lineTotal: +line.toFixed(2),
      };
    });
    const total = items.reduce((s,i)=>s+i.lineTotal,0);
    const payload = { nombre:name, fecha, hora, total:+total.toFixed(2), items };

    const btn   = $('#sendBtn');
    const msgEl = $('#orderMsg');
    const prevTxt = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Enviando…';
    msgEl.style.display = 'none';
    msgEl.textContent = '';

    // Mensaje de WhatsApp (fallback)
    const waMsg = buildWhatsappMessage({name, fecha, hora, notas, cart:c});

    // Registrar (no bloquea el envío)
    let folio = '';
    try{
      const fd = new FormData();
      fd.append('payload', JSON.stringify(payload));
      const res  = await fetch(ORDERS_ENDPOINT, { method:'POST', body: fd });
      const data = await res.json(); // si CORS bloquea, lanzará error
      if (!data.ok) throw new Error(data.error || 'Error servidor');
      folio = data.id || '';
      msgEl.style.display = 'block';
      msgEl.textContent = 'Pedido registrado. Folio: ' + folio;
    }catch(err){
      console.warn('Registro en Sheets falló:', err);
      msgEl.style.display = 'block';
      msgEl.textContent = 'No se pudo registrar el pedido, pero se enviará por WhatsApp.';
    }

    // Abrir WhatsApp SIEMPRE
    window.open(`https://wa.me/${tel}?text=${waMsg}`,'_blank');

    // Limpiar y restaurar UI
    setCart([]);
    renderCart();
    btn.disabled = false;
    btn.textContent = prevTxt;
  }
</script>

<!-- ============== HELPERS + ARRANQUE ============== -->
<script>
  // Acepta qty o quantity; calcula unit price desde subtotal si hace falta
  window.__getQty = (it) => Number((it.qty ?? it.quantity) || 1);
  window.__getUnit = (it) => {
    const q = window.__getQty(it);
    if (it.unitPrice != null) return Number(it.unitPrice);
    const sub = Number(it.price || 0);
    return q > 0 ? sub / q : 0;
  };

  // Render al cargar
  document.addEventListener('DOMContentLoaded', () => {
    try { renderCart(); } catch (e) { console.error(e); }
  });
</script>
</body>
</html>
